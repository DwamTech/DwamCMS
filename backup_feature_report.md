# تقرير ميزة النسخ الاحتياطي (Backup) + خطة التنفيذ والمقارنة

## 1) الهدف والمتطلبات المطلوبة
- عمل باك أب أوتوماتيك كل 3 أيام.
- حذف تلقائي لأي باك أب تعدّى شهر (30 يوم) بدون استثناءات.
- ملف `zip` يحتوي على:
  - Dump لقاعدة البيانات.
  - نسخة كاملة من بيانات الملفات (بالذات الصور والملفات) من مجلد `storage`.
- إدارة كاملة للباك أب: إنشاء، عرض، تحميل، استرجاع (Database + Files)، ومراقبة صحة النسخ.
- تنفيذ على Laravel بدون مشاكل تشغيلية (أداء/مساحة/أمان) وبطريقة قابلة للتوسع (مثلاً رفع إلى S3).

## 2) المعايير (Quality/Operational Criteria)
### 2.1 الاعتمادية والاسترجاع
- **RPO (Recovery Point Objective):** الحد الأقصى لفقد البيانات = 3 أيام (حسب الجدولة).
- **RTO (Recovery Time Objective):** زمن الاسترجاع يجب أن يكون قابل للتوقع ومناسب لحجم البيانات (يوضع Target واقعي حسب الحجم).
- **قابلية نقل النسخة:** محتوى `zip` يجب أن يكون “portable” (نفس الهيكل داخل الملف على أي سيرفر)، وليس مبني على مسارات مطلقة.
- **تحقق بعد النسخ:** النسخ الناجح = (وجود ملف zip) + (وجود dump) + (إمكانية فتح zip) + (إمكانية فحص محتوى أساسي مثل وجود مسارات `storage/app/public`).

### 2.2 الأمان
- عدم تضمين أسرار داخل النسخة (خصوصاً `.env`، مفاتيح API، ملفات مفاتيح خاصة…).
- تشفير أرشيف النسخة (اختياري/موصى به) عبر `BACKUP_ARCHIVE_PASSWORD`.
- صلاحيات الوصول: API للباك أب لازم تكون Admin فقط، مع تدقيق إضافي أثناء الاسترجاع.
- الاسترجاع لا يجب أن يسرّب كلمات مرور في أوامر النظام (process list) أو logs.

### 2.3 الأداء والسعة
- النسخ يجب أن لا تؤثر على تجربة المستخدم: يفضّل تشغيله كـ schedule خارج ساعات الذروة.
- سياسة مساحة واضحة: حد أقصى للمساحة أو تنبيه عند اقتراب الامتلاء.
- استبعاد مجلدات غير لازمة لتقليل حجم النسخة (مثل `vendor`, `node_modules`, `storage/framework`, `storage/logs`).

### 2.4 المراقبة والتنبيه
- إنذار عند فشل النسخ أو التنظيف.
- Health check متوافق مع تواتر النسخ (لا يعتبر النظام “غير صحي” بسبب جدول كل 3 أيام).

## 3) خطة تنفيذ نظام كامل على Laravel (بدون مشاكل)
### 3.1 اختيار أداة التنفيذ
الموجود حالياً يستخدم `spatie/laravel-backup` وهو خيار ممتاز لأنه يغطي:
- إنشاء zip يحتوي dump قواعد البيانات + ملفات.
- تنظيف (Retention) عبر `backup:clean`.
- مراقبة صحة النسخ عبر `backup:monitor`.

### 3.2 تصميم نطاق النسخة (Scope)
الحد الأدنى المطلوب لتحقيق “DB + storage”:
- **Database:** الاتصالات المطلوبة (مثلاً `mysql`).
- **Files:** `storage/app/public` (صور و PDF) + أي مسارات أخرى تستخدمها المنظومة (إن وجدت).

ملاحظة مهمة: في هذا المشروع رفع الصور والملفات يتم على قرص `public` داخل `storage/app/public`:
- `app/Services/ImageUploadService.php:53-80`
- `app/Services/FileUploadService.php:24-38`

### 3.3 سياسة الاحتفاظ (Retention) المطلوبة
المطلوب “حذف أي نسخة تعدّي 30 يوم” يعني **سياسة صارمة**:
- الاحتفاظ بكل النسخ حتى 30 يوم.
- عدم الاحتفاظ أسبوعي/شهري/سنوي خارج 30 يوم.
- تنفيذ `backup:clean` يومياً.

### 3.4 جدولة التشغيل
- `backup:run` كل 3 أيام.
- `backup:clean` يومياً.
- `backup:monitor` يومياً لكن بمعايير عمر (MaximumAgeInDays) متوافقة مع 3 أيام.

مهم جداً: تشغيل الجدولة في السيرفر (cron) عبر:
- `php artisan schedule:run` كل دقيقة (CRON على السيرفر)، أو استخدام Scheduler service حسب نوع الاستضافة.

### 3.5 الرفع إلى تخزين خارجي (اختياري موصى به)
- إضافة قرص تخزين ثاني لوجهة النسخ (مثلاً `s3`) وتفعيل تخزين النسخ عليه.
- تطبيق نفس سياسة التنظيف على جميع الأقراص.

### 3.6 الاسترجاع (Restore) بصورة صحيحة وسلسة
الاسترجاع “الكامل” يتطلب خطوتين:
- **Restore DB** من dump.
- **Restore Files** (على الأقل `storage/app/public`) مع استراتيجية آمنة:
  - وضع النظام في maintenance mode أثناء الاسترجاع.
  - أخذ نسخة “قبل الاسترجاع” (Safety Net).
  - استخراج `zip` إلى مجلد مؤقت.
  - استبدال مجلدات الملفات المطلوبة بشكل ذري (atomic) قدر الإمكان (rename/swap).
  - إعادة تشغيل الخدمات اللازمة (cache/config) بعد الاسترجاع.

### 3.7 توحيد إدارة النسخ عبر API/لوحة تحكم
الحد الأدنى للـ API:
- List backups.
- Download backup.
- Create backup (Full أو DB-only حسب اختيار واضح).
- Restore backup (Full restore أو DB-only حسب اختيار واضح).
- (اختياري) Upload backup zip إلى السيرفر للاسترجاع.

## 4) الوضع الحالي في المشروع (As-Is) مع مراجع للكود
### 4.1 الحزمة والإعدادات
- استخدام `spatie/laravel-backup` موجود: `composer.json:8-15`.
- ملف إعدادات Spatie موجود: `config/backup.php`.
- النسخ تُخزّن على `disk=local` فقط: `config/backup.php:158-164`.
- قرص `local` في هذا المشروع يشير إلى `storage/app/private`: `config/filesystems.php:33-39`.

### 4.2 الجدولة (Schedule)
موجودة داخل `routes/console.php`:
- تشغيل النسخ كل 3 أيام الساعة 2 صباحاً: `routes/console.php:11-13`
- تنظيف يومي: `routes/console.php:14-15`
- مراقبة يومية: `routes/console.php:17-18`

ملاحظة تشغيلية: هذا يعتمد على تفعيل cron الخاص بـ Laravel Scheduler في السيرفر.

### 4.3 إدارة النسخ عبر API
Routes موجودة ومحمية بـ `auth:sanctum` ثم `admin`: `routes/api.php:28-55`
- `GET /api/backups` list: `app/Http/Controllers/BackupController.php:16-45`
- `GET /api/backups/download` download: `app/Http/Controllers/BackupController.php:50-73`
- `POST /api/backups/create` manual create: `app/Http/Controllers/BackupController.php:88-107`
- `POST /api/backups/restore` restore: `app/Http/Controllers/BackupController.php:112-194`

## 5) الفجوات والمشاكل الحالية (Gaps/Risks)
### 5.1 النسخ اليدوي لا يحقق المتطلب (DB + storage)
- Endpoint الإنشاء اليدوي يستخدم `--only-db`:
  - `app/Http/Controllers/BackupController.php:88-103`
- هذا يخالف المتطلب الذي يريد zip فيه قاعدة البيانات + `storage` (صور/ملفات).

### 5.2 سياسة الاحتفاظ الحالية ليست “حذف صارم بعد شهر”
في `config/backup.php`:
- الإعدادات الحالية تحفظ نسخ أسبوعية/شهرية/سنوية بعد 30 يوم:
  - `config/backup.php:303-336`
- المطلوب: حذف أي نسخة بعد 30 يوم (بدون إبقاء شهري/سنوي).

### 5.3 Health check غير متوافق مع جدول كل 3 أيام
- `MaximumAgeInDays` مضبوط على 1 يوم:
  - `config/backup.php:264-272`
- مع نسخ كل 3 أيام، النظام سيفشل مراقبة الصحة في اليوم الثاني/الثالث بشكل طبيعي.

### 5.4 الاسترجاع الحالي يسترجع قاعدة البيانات فقط
- `restore()` يبحث عن ملف `.sql` ويعمل import فقط:
  - `app/Http/Controllers/BackupController.php:165-184`
- لا يوجد أي استرجاع للملفات (صور/PDF) داخل `storage/app/public`، وبالتالي الاسترجاع “الكامل” غير متحقق.

### 5.5 قابلية نقل النسخة (Portability) ضعيفة
- `relative_path` مضبوط على `null`:
  - `config/backup.php:52-53`
- هذا يجعل المسارات داخل zip “غير موحدة” بين البيئات (قد تظهر مسارات مطلقة)، ويصعّب الاسترجاع على سيرفر مختلف.

### 5.6 مخاطر أمان وتشغيل في استرجاع قاعدة البيانات
- الاسترجاع يستخدم `exec()` مع بناء أمر `mysql ... < file.sql`:
  - `app/Http/Controllers/BackupController.php:233-277`
- مشكلات محتملة:
  - كلمة المرور تُمرر في الـ command line (قد تظهر في process list في بعض الأنظمة).
  - الـ redirection `<` قد لا يعمل بشكل موحد على جميع البيئات (خصوصاً Windows) حسب shell المستخدم.
  - لا يوجد وضع maintenance mode ولا خطوات تحضير/rollback للملفات.

### 5.7 نطاق النسخ الحالي أوسع من المطلوب وقد يضم ملفات حساسة
- `config/backup.php` يضم `base_path()` بالكامل:
  - `config/backup.php:20-23`
- لا يوجد استبعاد صريح لـ `.env` في `exclude`:
  - `config/backup.php:29-35`
- هذا قد يؤدي لتسريب أسرار ضمن النسخة.

### 5.8 الرفع إلى تخزين خارجي غير مُفعّل في النسخ
- يوجد قرص `s3` معرف: `config/filesystems.php:50-61`
- لكن `config/backup.php` لا يضيف `s3` ضمن `destination.disks`:
  - `config/backup.php:158-164`

## 6) المقارنة: الخطة مقابل الموجود حالياً (ملخص تنفيذي)
- **الجدولة كل 3 أيام:** موجودة (`routes/console.php:12`) لكن تعتمد على Cron السيرفر.
- **حذف النسخ بعد شهر:** موجود تنظيف، لكن سياسة retention الحالية غير صارمة (تحتفظ بأقدم من شهر).
- **Zip يحتوي DB + storage:** النسخ الأوتوماتيك عبر `backup:run` قد يضم الملفات، لكن الإنشاء اليدوي حالياً DB فقط.
- **استرجاع كامل (DB + Files):** غير موجود حالياً (Database فقط).
- **رفع لوجهة خارجية:** غير مفعل حالياً (مع توفر إعدادات S3).
- **Health monitoring:** موجود لكنه مضبوط بقيمة غير متوافقة مع جدول النسخ.
- **الأمان (عدم تضمين أسرار):** غير مضمون بسبب عدم استبعاد `.env` صراحةً.

## 7) توصيات تنفيذ (Prioritized Backlog)
### P0 (لازم قبل اعتبار الميزة “شغالة صح”)
- جعل الإنشاء اليدوي يدعم Full backup (DB + storage) بوضوح.
- تطبيق retention صارم 30 يوم (بدون أسبوعي/شهري/سنوي خارج الشهر).
- ضبط `MaximumAgeInDays` بما يتناسب مع 3 أيام (مثلاً 4 أو 5).
- تنفيذ Full restore (DB + `storage/app/public`) مع خطوات آمنة (maintenance + rollback).
- جعل محتوى zip portable عبر `relative_path`.
- استبعاد `.env` وأي ملفات secrets من النسخ.

### P1 (مهم جداً للاستمرارية)
- إضافة تخزين خارجي (S3) كوجهة ثانية للنسخ.
- إشعارات عند الفشل (mail/slack) وإعداد Notifiable بشكل صحيح.
- تسجيل أحداث النسخ والتنظيف (logs أو جدول بسيط) لمتابعة الحالة تاريخياً.

### P2 (تحسينات تشغيلية)
- تشغيل النسخ كـ queued job لتخفيف الضغط على request/response لو تم استدعاؤه من API.
- endpoint لرفع zip بهدف الاسترجاع (مع قيود حجم/نوع الملف).
- سياسات صلاحيات أدق (مثلاً صلاحية منفصلة “backup:restore”).

