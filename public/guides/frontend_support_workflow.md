# دليل إدارة طلبات الدعم (Frontend Guide)

هذا المستند يشرح كيفية التعامل مع نظام طلبات الدعم (الأفراد والمؤسسات) من حيث الـ API، دورة حياة الطلب، والمنطق البرمجي.

---

## 1. دورة حياة الطلب (Workflow)

رحلة الطلب تمر بالمراحل التالية بشكل تسلسلي:

1.  **`pending` (تحت المراجعة الأولية)**:
    *   الحالة الافتراضية عند وصول الطلب من العميل.
    *   يقوم الأدمن بمراجعة البيانات الأساسية.

2.  **`waiting_for_documents` (بانتظار المرفقات)**:
    *   يقوم الأدمن بتحويل الطلب لهذه الحالة إذا وافق مبدئياً.
    *   **هام:** يجب على الأدمن كتابة رسالة توضيحية (`admin_response_message`) تظهر للعميل (مثلاً: "يرجى رفع سند القبض وتقرير المشروع").
    *   في هذه المرحلة، يظهر للعميل زر لرفع الملفات المطلوبة.

3.  **`documents_review` (مراجعة المرفقات)**:
    *   تتحول الحالة تلقائياً لهذه المرحلة بمجرد قيام العميل برفع الملفات المطلوبة.
    *   يقوم الأدمن بمراجعة الملفات المرفقة (سند القبض، التقرير، إلخ).

4.  **`completed` (مكتمل)**:
    *   القرار النهائي بالموافقة وإغلاق الطلب بنجاح.

5.  **`rejected` (مرفوض)**:
    *   يمكن الانتقال لهذه الحالة من أي مرحلة سابقة.
    *   يجب ذكر سبب الرفض (`rejection_reason`).

6.  **`archived` (مؤرشف)**:
    *   للطلبات القديمة أو غير النشطة.

---

## 2. API Endpoints

### أ. قائمة الطلبات (List)
*   **الأفراد:** `GET /api/admin/support/individual/requests`
*   **المؤسسات:** `GET /api/admin/support/institutional/requests`
*   **معلمات التصفية (Query Params):**
    *   `page`: رقم الصفحة (Pagination).
    *   `status`: تصفية حسب الحالة (مثلاً `pending`, `completed`).
    *   `search`: بحث بالاسم، رقم الطلب، أو الهاتف.

### ب. تفاصيل الطلب (Details)
*   **الأفراد:** `GET /api/admin/support/individual/requests/{id}`
*   **المؤسسات:** `GET /api/admin/support/institutional/requests/{id}`

### ج. تحديث حالة الطلب (Update Status)
يستخدم لتغيير الحالة وإضافة رد الأدمن.
*   **الأفراد:** `POST /api/admin/support/individual/requests/{id}/update`
*   **المؤسسات:** `POST /api/admin/support/institutional/requests/{id}/update`
*   **البيانات المرسلة (Body):**
    ```json
    {
        "status": "waiting_for_documents", // إجباري
        "admin_response_message": "يرجى رفع الملفات التالية...", // اختياري (مهم عند طلب ملفات)
        "rejection_reason": "سبب الرفض..." // إجباري فقط في حالة الرفض
    }
    ```

### د. رفع ملفات الوورك فلو (للعميل)
يستخدم هذا الرابط من قبل العميل عندما تكون حالته `waiting_for_documents`.
*   **الرابط:** `POST /api/support/workflow/upload`
*   **البيانات:**
    *   `request_number`: رقم الطلب.
    *   `phone_number`: رقم الهاتف.
    *   `type`: نوع الطلب (`individual` أو `institutional`).
    *   `closure_receipt`: ملف (سند قبض).
    *   `project_report`: ملف (تقرير المشروع).
    *   `support_letter_response`: ملف (خطاب الدعم - للمؤسسات).

---

## 3. Data Structure (هيكل البيانات)

### الحقول الأساسية المهمة للعرض:
*   `id`: المعرف.
*   `request_number`: رقم الطلب المميز (مثل `SUP-2025-ABCD`).
*   `full_name` / `institution_name`: اسم مقدم الطلب.
*   `status`: الحالة الحالية (انظر القسم 1).
*   `created_at`: تاريخ التقديم.
*   `admin_response_message`: رسالة الأدمن الأخيرة للعميل.
*   `rejection_reason`: سبب الرفض (إن وجد).

### ملفات الدورة المستندية (تظهر بعد الرفع):
*   `closure_receipt_path`: مسار سند القبض.
*   `project_report_path`: مسار تقرير المشروع.
*   `support_letter_response_path`: مسار خطاب الرد (مؤسسات فقط).

---

## 4. Business Logic & Permissions

*   **الصلاحيات:** جميع روابط `api/admin/*` تتطلب توكن أدمن (`Bearer Token`).
*   **قواعد الرفض:** لا يمكن تحويل الطلب لـ `rejected` بدون كتابة `rejection_reason`.
*   **قواعد طلب الملفات:** يفضل كتابة رسالة توضيحية في `admin_response_message` عند التحويل لـ `waiting_for_documents` ليعرف العميل ما المطلوب منه.
*   **الأتمتة:** لا يحتاج الأدمن لتحويل الطلب لـ `documents_review` يدوياً؛ النظام يقوم بذلك تلقائياً بمجرد رفع العميل للملفات.

---

## 5. منطق رسائل الأدمن للعميل (Admin Communication Logic)

يشرح هذا الجزء كيفية استخدام حقول الرسائل للتواصل مع العميل في الحالات المختلفة:

### أ. عند طلب مستندات إضافية (القبول المبدئي)
*   **الحالة المستهدفة:** `waiting_for_documents`.
*   **الإجراء:** يقوم الأدمن باختيار هذه الحالة من القائمة.
*   **حقل الرسالة:** `admin_response_message` (إجباري في الـ UI يفضل، لكنه اختياري في الـ API).
*   **المحتوى المقترح:** "تم قبول الطلب مبدئياً. يرجى رفع سند القبض وتقرير المشروع لاستكمال الإجراءات."
*   **النتيجة:** العميل سيرى هذه الرسالة في شاشة "متابعة الطلب" وفوراً يظهر له زر رفع الملفات.

### ب. عند الرفض (Rejection)
*   **الحالة المستهدفة:** `rejected`.
*   **الإجراء:** اختيار "رفض".
*   **حقل الرسالة:** `rejection_reason` (إجباري من الـ API).
*   **المحتوى المقترح:** توضيح سبب الرفض بدقة (مثل: "نقص في الشروط"، "الميزانية غير متوفرة").
*   **النتيجة:** العميل يرى حالة الطلب "مرفوض" وسبب الرفض، وتتوقف العملية.

### ج. عند القبول النهائي (Completion)
*   **الحالة المستهدفة:** `completed`.
*   **الإجراء:** اختيار "مكتمل" بعد مراجعة الملفات المرفوعة.
*   **حقل الرسالة:** `admin_response_message` (اختياري).
*   **المحتوى المقترح:** "تم تحويل المبلغ بنجاح، شكراً لكم."
*   **النتيجة:** تظهر الحالة "مكتمل" للعميل.

### د. تعديل الرسالة
*   إذا أردت تعديل رسالة أرسلتها سابقاً (مثلاً لتصحيح خطأ إملائي أو إضافة تفاصيل)، يمكنك ببساطة استدعاء `POST .../update` مرة أخرى بنفس الحالة (`status`) وبمحتوى جديد في `admin_response_message`.

---

## 6. إحصائيات
يمكن معرفة عدد الطلبات في كل حالة عبر `GET /api/admin/dashboard/summary` (تم تجهيزها سابقاً لتعيد إجماليات عامة، ويمكن فلترة قائمة الطلبات للحصول على أعداد محددة لكل حالة).
